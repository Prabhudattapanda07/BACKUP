<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BlockFarm â€” Interactive Prototype</title>
    <style>
        :root {
            --bg: #f7fbf6;
            --card: #ffffff;
            --accent: #2f855a;
            --muted: #6b7280;
            --hover: #38a169;
        }

        * {
            box-sizing: border-box;
            transition: all 0.25s ease-in-out;
        }

        body {
            font-family: Inter, system-ui, Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: #111;
            overflow-x: hidden;
        }

        .container {
            max-width: 1100px;
            margin: 28px auto;
            padding: 20px;
            animation: fadeIn 0.6s ease;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e6e9ef;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: var(--accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-left: auto;
        }

        nav button {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #eef6ef;
            cursor: pointer;
            font-weight: 500;
        }

        nav button:hover {
            background: var(--accent);
            color: #fff;
            transform: scale(1.05);
        }

        #reset-data {
            background: #fee2e2;
            color: #b91c1c;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        #reset-data:hover {
            background: #fca5a5;
            color: #fff;
            transform: translateY(-1px);
        }

        .dark-toggle {
            display: flex;
            align-items: center;
            margin-left: 12px;
            order: 1;
        }

        .dark-toggle input {
            display: none;
        }

        .dark-toggle label {
            cursor: pointer;
            font-size: 18px;
            padding: 6px 12px;
            border-radius: 8px;
            background: #eef6ef;
            transition: background 0.3s;
        }

        .dark-toggle label:hover {
            background: var(--accent);
            color: #fff;
        }

        .card {
            background: var(--card);
            padding: 16px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(10, 10, 10, 0.06);
            animation: fadeUp 0.4s ease;
        }

        h1,
        h2 {
            margin: 0;
        }

        .grid {
            display: grid;
            gap: 16px;
        }

        .grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        form input,
        form textarea,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6e9ef;
            outline: none;
        }

        form input:focus,
        form textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(47, 133, 90, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            background: var(--hover);
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #eef6ef;
            color: var(--accent);
        }

        .btn.secondary:hover {
            background: #d9f2e0;
            transform: translateY(-2px);
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        footer {
            margin-top: 22px;
            text-align: center;
            color: var(--muted);
            font-size: 13px;
        }

        @media (max-width: 800px) {
            .grid.cols-3 {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-buttons {
                margin-left: 0;
                margin-top: 8px;
            }

            .dark-toggle {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        .qr-box canvas:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.dark-mode {
            --bg: #1a202c;
            --card: #2d3748;
            --accent: #48bb78;
            --muted: #a0aec0;
            --hover: #38a169;
            color: #f7fafc;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="brand">
                <div class="logo">BF</div>
                <div>
                    <h1>BlockFarm</h1>
                    <div class="small">Trace produce â€” farm to consumer (prototype)</div>
                </div>
            </div>
            <nav class="nav-buttons">
                <button id="nav-dashboard">Dashboard</button>
                <button id="nav-register">Register Batch</button>
                <button id="nav-transport">Transport Update</button>
                <button id="nav-consumer">Consumer Scan</button>
                <button id="export-state">Export Data</button>
                <button id="reset-data">Reset</button>
            </nav>
            <div class="dark-toggle">
                <input type="checkbox" id="darkSwitch">
                <label for="darkSwitch">ðŸŒ™</label>
            </div>
        </header>

        <main id="main" style="margin-top:18px"></main>

        <footer class="small">Prototype â€” simulated blockchain (localStorage). Replace with real smart-contract & IPFS
            for production.</footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  // ===== Supabase Setup =====
  const SUPABASE_URL = "https://soklrmyzjssnavfgjphk.supabase.co"; 
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNva2xybXl6anNzbmF2ZmdqcGhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMDk2NzgsImV4cCI6MjA3Mjg4NTY3OH0.JojIUN-TRBaqU1DXbc7ex14BDgubZB8rMJwQE4sFCbk"; // âš¡ Replace this
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const main = document.getElementById('main');

  // ===== Dark Mode =====
  document.getElementById('darkSwitch').addEventListener('change', e => {
    document.body.classList.toggle('dark-mode', e.target.checked);
  });

  // ===== Reset data =====
  document.getElementById('reset-data').addEventListener('click', async () => {
    if (confirm('Are you sure you want to clear all data?')) {
      await supabaseClient.from("batches").delete().neq("id", 0); // delete all
      location.reload();
    }
  });

  // ===== Supabase Functions =====
  async function saveBatchIndex(batch) {
    const { data, error } = await supabaseClient.from("batches").insert([batch]);
    if (error) console.error("Error saving batch:", error);
    return data;
  }

  async function getBatchIndex() {
    const { data, error } = await supabaseClient
      .from("batches")
      .select("*")
      .order("id", { ascending: false });
    if (error) {
      console.error("Error fetching batches:", error);
      return [];
    }
    return data;
  }

  async function updateBatchStatus(id, status) {
    const { error } = await supabaseClient
      .from("batches")
      .update({ status })
      .eq("id", id);
    if (error) console.error("Error updating status:", error);
  }

  async function deleteBatch(id) {
    const { error } = await supabaseClient.from("batches").delete().eq("id", id);
    if (error) console.error("Error deleting batch:", error);
  }

  // ===== Fade view helper =====
  function fadeInView(html) {
    main.innerHTML = html;
    main.classList.add('fade-view');
    setTimeout(() => main.classList.add('show'), 50);
  }

  // ===== Show Dashboard =====
  async function showDashboard() {
    const batches = await getBatchIndex();

    if (batches.length === 0) {
      fadeInView(`<section class="card"><h2>Batches</h2><p>No batches available.</p></section>`);
      return;
    }

    fadeInView(`<section class="card"><h2>Batches</h2>
        <div style="margin-top:12px"><div class="list" id="batches-list"></div></div>
      </section>`);

    const listEl = document.getElementById('batches-list');
    listEl.innerHTML = '';

    batches.forEach(b => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">Batch ID</div><div style="font-weight:700">#${b.id}</div></div>
          <div class="small">Status<br><strong>${b.status || 'Registered'}</strong></div>
        </div>
        <div style="margin-top:8px">Crop: ${b.cropType || '-'}<br>Farmer: ${b.farmerName || '-'}</div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" data-batch="${b.id}" data-action="view">View</button>
          <button class="btn secondary" data-batch="${b.id}" data-action="retail">Retail Arrival</button>
          <button class="btn danger" style="background:#dc2626" data-batch="${b.id}" data-action="delete">Delete</button>
          <div class="qr-box" id="qr-${b.id}"></div>
        </div>
      `;
      listEl.appendChild(div);

      const qrBox = div.querySelector(`#qr-${b.id}`);
      const qr = document.createElement('canvas');
      qr.style.width = '64px';
      qr.style.height = '64px';
      qrBox.appendChild(qr);
      new QRious({
        element: qr,
        value: `https://prabhudattapanda07.github.io/BACKUP/#batch=${b.id}`,
        size: 64
      });

      // Add click listeners
      div.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const action = btn.getAttribute('data-action');
          if (action === 'view') {
            alert(`Batch Info:\nFarmer: ${b.farmerName}\nCrop: ${b.cropType}\nQuantity: ${b.quantity}`);
          }
          else if (action === 'retail') {
            alert(`Retail Arrival updated for Batch #${b.id}`);
            await updateBatchStatus(b.id, 'Arrived at Retail');
            showDashboard();
          }
          else if (action === 'delete') {
            if (confirm(`Delete Batch #${b.id}?`)) {
              await deleteBatch(b.id);
              showDashboard();
            }
          }
        });
      });
    });
  }

  // ===== Show Register Form =====
  function showRegister() {
    fadeInView(`<section class="card"><h2>Register New Batch</h2>
      <form id="register-form" style="margin-top:12px">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
          <input name="farmerName" placeholder="Farmer name" required />
          <input name="cropType" placeholder="Crop type (Tomato)" required />
          <input name="quantity" placeholder="Quantity (kg)" required />
          <input name="harvestDate" type="date" required />
        </div>
        <textarea name="notes" placeholder="Notes (organic, pesticide-free)" style="margin-top:10px"></textarea>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn">Register</button>
          <button type="button" class="btn secondary" id="clear-reg">Clear</button>
        </div>
      </form></section>`);

    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const fm = new FormData(registerForm);
      const metadata = {
        farmerName: fm.get('farmerName'),
        cropType: fm.get('cropType'),
        quantity: fm.get('quantity'),
        harvestDate: fm.get('harvestDate'),
        notes: fm.get('notes'),
        status: 'Registered'
      };
      await saveBatchIndex(metadata);
      showDashboard();
    });
    document.getElementById('clear-reg').addEventListener('click', () => registerForm.reset());
  }

  // ===== Show Transport Update =====
  async function showTransport() {
    const batches = await getBatchIndex();
    if (batches.length === 0) {
      fadeInView(`<section class="card"><h2>Transport / Handover Update</h2><p>No batches available.</p></section>`);
      return;
    }
    fadeInView(`<section class="card"><h2>Transport / Handover Update</h2>
      <div style="margin-top:10px">
        <label class="small">Select Batch</label>
        <select id="select-batch">
          ${batches.map(b => `<option value="${b.id}">#${b.id} â€” ${b.cropType} â€” ${b.farmerName}</option>`).join('')}
        </select>
      </div>
      <form id="transport-form" style="margin-top:10px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input name="transporterName" placeholder="Transporter name" required />
          <input name="location" placeholder="Location / checkpoint" required />
        </div>
        <textarea name="notes" placeholder="Notes" style="margin-top:10px"></textarea>
        <button class="btn" style="margin-top:10px">Update</button>
      </form></section>`);

    document.getElementById('transport-form').addEventListener('submit', async e => {
      e.preventDefault();
      const fm = new FormData(e.target);
      const batchId = document.getElementById('select-batch').value;
      await updateBatchStatus(batchId, 'In Transit');
      alert(`Transport update recorded for Batch #${batchId}`);
      showDashboard();
    });
  }

  // ===== Consumer Scan =====
  function showConsumer() {
    fadeInView(`<section class="card"><h2>Consumer Scan</h2>
      <p>Scan QR or enter Batch ID</p>
      <input id="scan-input" placeholder="Enter Batch ID" />
      <button id="scan-btn" class="btn" style="margin-top:8px">Scan</button>
      <div id="scan-output" style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap;"></div>
    </section>`);

    const scanBtn = document.getElementById('scan-btn');
    const scanInput = document.getElementById('scan-input');
    const output = document.getElementById('scan-output');

    scanBtn.addEventListener('click', async () => {
      const val = scanInput.value.trim();
      const batches = await getBatchIndex();
      const batch = batches.find(b => b.id == val);
      if (!batch) {
        output.innerHTML = "<p>No batch found with this ID.</p>";
        return;
      }

      output.innerHTML = '';
      const qrCanvas = document.createElement('canvas');
      qrCanvas.style.width = '128px'; qrCanvas.style.height = '128px';
      output.appendChild(qrCanvas);
      const qrValue = `https://prabhudattapanda07.github.io/BACKUP/#batch=${batch.id}`;
      new QRious({ element: qrCanvas, value: qrValue, size: 128 });

      const infoCard = document.createElement('div');
      infoCard.className = 'card';
      infoCard.style.flex = '1'; infoCard.style.minWidth = '200px';
      infoCard.innerHTML = `<h3>Batch #${batch.id}</h3>
        <p><strong>Farmer:</strong> ${batch.farmerName}</p>
        <p><strong>Crop:</strong> ${batch.cropType}</p>
        <p><strong>Quantity:</strong> ${batch.quantity}</p>
        <p><strong>Harvest Date:</strong> ${batch.harvestDate}</p>
        <p><strong>Notes:</strong> ${batch.notes}</p>
        <p><strong>Status:</strong> ${batch.status || 'Registered'}</p>`;
      output.appendChild(infoCard);
    });
  }

  // ===== Export Data to CSV =====
  document.getElementById('export-state').addEventListener('click', async () => {
    const batches = await getBatchIndex();
    if (batches.length === 0) { alert("No data to export."); return; }

    let csv = "Batch ID,Farmer,Crop,Quantity,Harvest Date,Notes,Status\n";
    batches.forEach(b => {
      csv += `${b.id},${b.farmerName},${b.cropType},${b.quantity},${b.harvestDate},${b.notes},${b.status}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "batches.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ===== Navigation =====
  document.getElementById('nav-dashboard').addEventListener('click', showDashboard);
  document.getElementById('nav-register').addEventListener('click', showRegister);
  document.getElementById('nav-transport').addEventListener('click', showTransport);
  document.getElementById('nav-consumer').addEventListener('click', showConsumer);
  showDashboard();
</script>
